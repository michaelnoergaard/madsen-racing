---
import Layout from '../layouts/Layout.astro';
import StatCard from '../components/StatCard.astro';
import RaceCard from '../components/RaceCard.astro';
import { getDriverStats, getResults, formatDate } from '../lib/contentful';

// Get 2025 driver stats and results from Contentful
let stats2025 = [];
let results2025 = [];

try {
  const driverStats = await getDriverStats('2025');
  if (driverStats) {
    const fields = driverStats.fields;
    stats2025 = [
      { value: fields.totalRaces?.toString() || '0', label: 'L√∏b' },
      { value: fields.wins?.toString() || '0', label: 'Sejre' },
      { value: fields.podiums?.toString() || '0', label: 'Podier' },
      { value: fields.fastestLaps?.toString() || '0', label: 'Hurtigste omgange' },
    ];
  }
} catch (error) {
  console.error('Error fetching driver stats:', error);
  // Fallback to empty stats
}

try {
  const races = await getResults('2025');
  results2025 = races.map(race => ({
    date: formatDate(race.fields.date),
    name: race.fields.title,
    track: race.fields.track,
    result: race.fields.result,
    notes: race.fields.notes,
  }));
} catch (error) {
  console.error('Error fetching results:', error);
  // Fallback to empty results
}

// Generate highlights based on stats
const highlights = [];
if (stats2025.length > 0) {
  const wins = parseInt(stats2025[1].value) || 0;
  const podiums = parseInt(stats2025[2].value) || 0;
  const championshipPosition = 2; // Could be fetched from driver stats

  if (championshipPosition === 1) {
    highlights.push({ title: 'DKM Mester 2025', description: 'Vandt det Danske Kart Mesterskab i OK Junior klassen' });
  } else if (championshipPosition === 2) {
    highlights.push({ title: 'DKM Vice-mester 2025', description: 'S√∏lvmedalje i Dansk Kart Mesterskab' });
  }

  if (wins > 0) {
    highlights.push({ title: `${wins} sejre${wins > 1 ? ' i s√¶sonen' : ''}`, description: `Fantastisk s√¶son med ${wins} sejr${wins > 1 ? 'er' : ''}` });
  }

  if (podiums >= 10) {
    highlights.push({ title: `${podiums} podiumplaceringer`, description: 'Imponerende konsistens gennem hele s√¶sonen' });
  }
}
---

<Layout 
  title="Resultater" 
  description="Se Anton Madsens karriereresultater, statistik og h√∏jdepunkter fra karting-s√¶sonen."
>
  <!-- Hero -->
  <section class="pt-32 pb-16 bg-mr-gradient-dark">
    <div class="max-w-6xl mx-auto px-4 text-center">
      <h1 class="text-4xl md:text-5xl font-black mb-4 font-display">
        RESULTATER & <span class="text-mr-yellow">STATISTIK</span>
      </h1>
      <p class="text-mr-gray-400 max-w-2xl mx-auto">
        F√∏lg med i Anton's karriereudvikling og resultater fra s√¶son til s√¶son.
      </p>
    </div>
  </section>

  <!-- Stats 2025 -->
  <section class="section bg-mr-black">
    <div class="max-w-6xl mx-auto px-4">
      <h2 class="section-title text-center mb-12">S√ÜSON <span class="text-mr-yellow">2025</span></h2>
      
      <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-12">
        {stats2025.map(stat => (
          <StatCard value={stat.value} label={stat.label} />
        ))}
      </div>
    </div>
  </section>

  <!-- Highlights -->
  <section class="section bg-mr-gray-900/50">
    <div class="max-w-4xl mx-auto px-4">
      <h2 class="text-2xl font-black mb-8 text-center">H√òJDEPUNKTER</h2>
      
      <div class="grid md:grid-cols-3 gap-6">
        {highlights.map((item, i) => (
          <div class="card-highlight text-center">
            <div class="text-4xl mb-3">üèÜ</div>
            <h3 class="font-bold text-mr-yellow mb-2">{item.title}</h3>
            <p class="text-mr-gray-400 text-sm">{item.description}</p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Results List -->
  <section class="section bg-mr-black">
    <div class="max-w-4xl mx-auto px-4">
      <h2 class="text-2xl font-black mb-8">ALLE RESULTATER 2025</h2>
      
      <div class="space-y-4">
        {results2025.map(race => (
          <RaceCard {...race} />
        ))}
      </div>
      
      <p class="text-center text-mr-gray-500 mt-8">
        Viser seneste 6 l√∏b. Fuld historik kommer snart.
      </p>
    </div>
  </section>
</Layout>
