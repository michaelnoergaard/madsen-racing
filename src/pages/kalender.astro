---
import Layout from '../layouts/Layout.astro';
import RaceCard from '../components/RaceCard.astro';
import { getRaces, formatDate, getPageSection } from '../lib/contentful';

// Get page sections from Contentful
const winterSection = await getPageSection('kalender-winter') || { fields: { heading: 'VINTER', description: '' } };
const springSection = await getPageSection('kalender-spring') || { fields: { heading: 'FORÅR', description: '' } };
const summerSection = await getPageSection('kalender-summer') || { fields: { heading: 'SOMMER', description: '' } };
const autumnSection = await getPageSection('kalender-autumn') || { fields: { heading: 'EFTERÅR', description: '' } };
const ctaSection = await getPageSection('kalender-cta-heading') || { fields: { heading: 'Følg med live på løbsdagene!', description: 'Vi deler opdateringer, live stories og resultater på Instagram og Facebook.' } };

// Helper function to get field value with fallback
const getField = (field: any): string => {
  if (!field) return '';
  if (typeof field === 'object' && !Array.isArray(field)) {
    return field['da-DK'] || field['en-US'] || field;
  }
  return field;
};

// Get 2026 races from Contentful
let allRaces = [];

try {
  const races = await getRaces('2026');
  allRaces = races.map(race => ({
    date: formatDate(race.fields.date),
    name: race.fields.title,
    track: race.fields.track,
    highlight: false, // Could be determined by championship importance
    result: race.fields.result,
    championship: race.fields.championship,
    country: race.fields.country,
    notes: race.fields.notes,
    originalDate: race.fields.date, // Keep original date for seasonal grouping
  }));
} catch (error) {
  console.error('Error fetching races:', error);
  // Fallback to empty races
}

// Group races by season
const groupRacesBySeason = (races) => {
  const vinter = [];
  const forår = [];
  const sommer = [];
  const efterår = [];

  races.forEach(race => {
    // Try to extract month from the original date (YYYY-MM-DD format)
    const dateStr = race.originalDate;

    if (dateStr) {
      const month = new Date(dateStr).getMonth() + 1; // getMonth() is 0-indexed

      if (month >= 3 && month <= 5) { // March-May
        forår.push(race);
      } else if (month >= 6 && month <= 8) { // June-August
        sommer.push(race);
      } else if (month >= 9 && month <= 11) { // September-November
        efterår.push(race);
      } else { // December (12), January (1), February (2)
        vinter.push(race);
      }
    }
  });

  return { vinter, forår, sommer, efterår };
};

const races2026 = groupRacesBySeason(allRaces);

// Get CTA button info from PageSection
const ctaButtonText = getField(ctaSection.fields.buttonText) || 'Instagram';
const ctaButtonUrl = getField(ctaSection.fields.buttonUrl) || 'https://instagram.com/madsenracing22';
---

<Layout
  title="Kalender 2026"
  description="Se Anton Madsens løbskalender for 2026 sæsonen - DKM, Nordic Championship og internationale løb."
>
  <!-- Hero -->
  <section class="pt-32 pb-16 bg-mr-gradient-dark">
    <div class="max-w-6xl mx-auto px-4 text-center">
      <h1 class="text-4xl md:text-5xl font-black mb-4 font-display">
        KALENDER <span class="text-mr-yellow">2026</span>
      </h1>
      <p class="text-mr-gray-400 max-w-2xl mx-auto">
        Følg med i Madsen Racing's sæson. Her finder du alle løb, datoer og baner for 2026.
      </p>
    </div>
  </section>

  <!-- Winter -->
  <section class="section bg-mr-black">
    <div class="max-w-4xl mx-auto px-4">
      <h2 class="text-2xl font-black mb-6 flex items-center gap-3">
        <span class="w-3 h-3 bg-blue-500 rounded-full"></span>
        {getField(winterSection.fields.heading)}
      </h2>
      <div class="space-y-4">
        {races2026.vinter.map(race => (
          <RaceCard {...race} />
        ))}
      </div>
    </div>
  </section>

  <!-- Spring -->
  <section class="section bg-mr-black">
    <div class="max-w-4xl mx-auto px-4">
      <h2 class="text-2xl font-black mb-6 flex items-center gap-3">
        <span class="w-3 h-3 bg-green-500 rounded-full"></span>
        {getField(springSection.fields.heading)}
      </h2>
      <div class="space-y-4">
        {races2026.forår.map(race => (
          <RaceCard {...race} />
        ))}
      </div>
    </div>
  </section>

  <!-- Summer -->
  <section class="section bg-mr-gray-900/50">
    <div class="max-w-4xl mx-auto px-4">
      <h2 class="text-2xl font-black mb-6 flex items-center gap-3">
        <span class="w-3 h-3 bg-mr-yellow rounded-full"></span>
        {getField(summerSection.fields.heading)}
      </h2>
      <div class="space-y-4">
        {races2026.sommer.map(race => (
          <RaceCard {...race} />
        ))}
      </div>
    </div>
  </section>

  <!-- Autumn -->
  <section class="section bg-mr-black">
    <div class="max-w-4xl mx-auto px-4">
      <h2 class="text-2xl font-black mb-6 flex items-center gap-3">
        <span class="w-3 h-3 bg-orange-500 rounded-full"></span>
        {getField(autumnSection.fields.heading)}
      </h2>
      <div class="space-y-4">
        {races2026.efterår.map(race => (
          <RaceCard {...race} />
        ))}
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section class="py-12 bg-mr-purple/20 border-y border-mr-purple/30">
    <div class="max-w-4xl mx-auto px-4 text-center">
      <h3 class="text-xl font-bold mb-4">{getField(ctaSection.fields.heading)}</h3>
      <p class="text-mr-gray-400 mb-6">
        {getField(ctaSection.fields.description)}
      </p>
      <div class="flex justify-center gap-4">
        <a href={ctaButtonUrl} target="_blank" rel="noopener noreferrer" class="btn-primary">
          {ctaButtonText}
        </a>
        <a href="https://facebook.com/madsenracing" target="_blank" rel="noopener noreferrer" class="btn-secondary">
          Facebook
        </a>
      </div>
    </div>
  </section>
</Layout>
