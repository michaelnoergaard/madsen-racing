---
import Layout from '../layouts/Layout.astro';
import { getMediaItems, getVideos, getFeaturedMediaItems, getFeaturedVideos, getPressPhotos, getPageSection } from '../lib/contentful';
import MediaGrid from '../components/media/MediaGrid.astro';
import YouTubePlayer from '../components/media/YouTubePlayer.astro';
import OptimizedImage from '../components/media/OptimizedImage.astro';

// Get page sections from Contentful
const catAllSection = await getPageSection('galleri-category-all') || { fields: { heading: 'ALLE', description: '' } };
const catRacingSection = await getPageSection('galleri-category-racing') || { fields: { heading: 'RACING ACTION', description: '' } };
const catBehindScenesSection = await getPageSection('galleri-category-behind-scenes') || { fields: { heading: 'BEHIND SCENES', description: '' } };
const catProfessionalSection = await getPageSection('galleri-category-professional') || { fields: { heading: 'PROFESSIONEL', description: '' } };
const catVideoSection = await getPageSection('galleri-category-video') || { fields: { heading: 'VIDEO', description: '' } };
const featuredHeadingSection = await getPageSection('galleri-featured-heading') || { fields: { heading: 'Udvalgte Billeder', description: '' } };
const galleryHeadingSection = await getPageSection('galleri-gallery-heading') || { fields: { heading: 'Billedgalleri', description: '' } };
const videosHeadingSection = await getPageSection('galleri-videos-heading') || { fields: { heading: 'Video Highlights', description: '' } };
const emptyMessageSection = await getPageSection('galleri-empty-message') || { fields: { heading: '', description: 'Ingen billeder fundet. Tjek Contentful indstillinger for at uploade medier.' } };
const videosButtonSection = await getPageSection('galleri-videos-button') || { fields: { heading: '', description: '', buttonText: 'Se Alle Videoer', buttonUrl: '#all-videos' } };

// Helper function to get field value with fallback
const getField = (field: any): string => {
  if (!field) return '';
  if (typeof field === 'object' && !Array.isArray(field)) {
    return field['da-DK'] || field['en-US'] || field;
  }
  return field;
};

// Media categories - now from PageSection
const categories = [
  getField(catAllSection.fields.heading),
  getField(catRacingSection.fields.heading),
  getField(catBehindScenesSection.fields.heading),
  getField(catProfessionalSection.fields.heading),
  getField(catVideoSection.fields.heading),
];

// Fetch data from Contentful
let mediaItems = [];
let videos = [];
let featuredMedia = [];
let featuredVideos = [];
let pressPhotos = [];

try {
  // Fetch data in parallel for better performance
  const [mediaData, videosData, featuredMediaData, featuredVideosData, pressPhotosData] = await Promise.all([
    getMediaItems(),
    getVideos(),
    getFeaturedMediaItems(6),
    getFeaturedVideos(4),
    getPressPhotos(),
  ]);

  mediaItems = mediaData;
  videos = videosData;
  featuredMedia = featuredMediaData;
  featuredVideos = featuredVideosData;
  pressPhotos = pressPhotosData;
} catch (error) {
  console.warn('Failed to fetch media from Contentful:', error);
}

// Get videos button info
const videosButtonText = getField(videosButtonSection.fields.buttonText) || 'Se Alle Videoer';
const videosButtonUrl = getField(videosButtonSection.fields.buttonUrl) || '#all-videos';
const videosCountText = videos.length > 3 ? `(${videos.length})` : '';
---

<Layout
  title="Galleri"
  description="Se billeder og videoer fra Anton Madsens karting-karriere - action, behind the scenes og højdepunkter."
>
  <!-- Hero -->
  <section class="pt-32 pb-16 bg-mr-gradient-dark">
    <div class="max-w-6xl mx-auto px-4 text-center">
      <h1 class="text-4xl md:text-5xl font-black mb-4 font-display">
        GALLERI & <span class="text-mr-yellow">MEDIA</span>
      </h1>
      <p class="text-mr-gray-400 max-w-2xl mx-auto">
        Billeder og videoer fra banen, paddocken og bag kulisserne.
      </p>
    </div>
  </section>

  <!-- Filter -->
  <section class="py-8 bg-mr-black border-b border-mr-gray-800">
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex flex-wrap justify-center gap-2" id="category-filters">
        {categories.map((cat, i) => (
          <button
            class:list={[
              'category-filter px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200',
              i === 0 ? 'bg-mr-yellow text-mr-black' : 'bg-mr-gray-800 text-mr-gray-400 hover:bg-mr-gray-700'
            ]}
            data-category={cat.toLowerCase()}
          >
            {cat}
          </button>
        ))}
      </div>
    </div>
  </section>

  <!-- Featured Media -->
  {featuredMedia.length > 0 && (
    <section class="section bg-mr-black">
      <div class="max-w-6xl mx-auto px-4">
        <h2 class="text-2xl font-black mb-6 flex items-center gap-2">
          <svg class="w-6 h-6 text-mr-yellow" fill="currentColor" viewBox="0 0 24 24">
            <path d="M3.00388 11.88C2.99995 11.88 2.99995 11.88 5.09992 11.88C6.6999 11.88 8.09994 13.08 9.09992 14.28C9.39992 14.68 9.69991 15.08 9.99992 15.48C9.09994 16.08 8.09994 16.68 7.09992 17.28C6.49992 17.88 5.59991 18.48 4.69995 18.88C4.09991 19.28 3.59992 19.68 3.09992 19.88C3.09992 19.68 3.09992 19.68 2.99995 19.88"/>
          </svg>
          {getField(featuredHeadingSection.fields.heading)}
        </h2>

        <MediaGrid
          items={featuredMedia}
          category="all"
          columns="3"
          gap="medium"
        />
      </div>
    </section>
  )}

  <!-- Main Gallery -->
  <section class="section bg-mr-black">
    <div class="max-w-6xl mx-auto px-4">
      <h2 class="text-2xl font-black mb-6">
        {getField(galleryHeadingSection.fields.heading)}
      </h2>

      {mediaItems.length > 0 ? (
        <MediaGrid
          items={mediaItems}
          category="all"
          layout="grid"
          columns="auto"
          gap="medium"
          className="main-gallery"
        />
      ) : (
        <div class="text-center py-12">
          <p class="text-mr-gray-500">
            {getField(emptyMessageSection.fields.description)}
          </p>
        </div>
      )}
    </div>
  </section>

  <!-- Videos Section -->
  {featuredVideos.length > 0 && (
    <section class="section bg-mr-gray-900/50">
      <div class="max-w-6xl mx-auto px-4">
        <h2 class="text-2xl font-black mb-6 flex items-center gap-2">
          <svg class="w-6 h-6 text-mr-yellow" fill="currentColor" viewBox="0 0 24 24">
            <path d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          {getField(videosHeadingSection.fields.heading)}
        </h2>

        <div class="grid md:grid-cols-2 gap-6 mb-8">
          {featuredVideos.map((video, index) => (
            <div key={video.sys.id} class="bg-mr-black rounded-lg overflow-hidden shadow-lg">
              {video.fields.youtubeVideoId ? (
                <YouTubePlayer
                  videoId={video.fields.youtubeVideoId}
                  videoUrl={video.fields.youtubeUrl}
                  title={video.fields.title}
                  thumbnail={video.fields.thumbnail?.fields?.file?.url}
                  className="w-full aspect-video"
                  width={640}
                  height={360}
                />
              ) : (
                <div class="aspect-video bg-gray-800 flex items-center justify-center text-gray-500">
                  <p>Video ikke tilgængelig</p>
                </div>
              )}

              <div class="p-4">
                <h3 class="font-bold text-white mb-2">{video.fields.title}</h3>
                {video.fields.description && (
                  <p class="text-mr-gray-400 text-sm mb-2">{video.fields.description}</p>
                )}
              </div>
            </div>
          ))}
        </div>

        {videos.length > 3 && (
          <div class="text-center">
            <a href={videosButtonUrl} class="btn-primary">
              {videosButtonText} {videosCountText}
            </a>
          </div>
        )}
      </div>
    </section>
  )}

  <script>
    // Gallery filtering functionality
    document.addEventListener('astro:page-load', () => {
      const filters = document.querySelectorAll('.category-filter');
      const gallery = document.querySelector('.main-gallery');

      filters.forEach(filter => {
        filter.addEventListener('click', (e) => {
          const category = e.target.dataset.category;

          // Update active state
          filters.forEach(f => {
            f.classList.remove('bg-mr-yellow', 'text-mr-black');
            f.classList.add('bg-mr-gray-800', 'text-mr-gray-400');
          });
          e.target.classList.remove('bg-mr-gray-800', 'text-mr-gray-400');
          e.target.classList.add('bg-mr-yellow', 'text-mr-black');

          // Filter gallery items (this would need the media items to be client-side or using Alpine.js)
          console.log(`Filtering by category: ${category}`);
        });
      });
    });
  </script>
</Layout>
