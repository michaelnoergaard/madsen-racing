---
import Layout from '../layouts/Layout.astro';
import SponsorLogo from '../components/SponsorLogo.astro';
import { getSponsors, getImageUrl, getPageSections } from '../lib/contentful';

interface Sponsor {
  name: string;
  logo?: string;
  website?: string;
  description?: string;
}

// Helper function to get field value with Danish locale fallback
const getField = (field: any): string => {
  if (!field) return '';
  if (typeof field === 'object' && !Array.isArray(field)) {
    return field['da-DK'] || field['en-US'] || field;
  }
  return field;
};

// Get page sections from Contentful
let sections: Record<string, { heading: string; description: string; buttonText?: string; buttonUrl?: string }> = {};

try {
  const sectionEntries = await getPageSections('sponsorer');

  sectionEntries.forEach((section: any) => {
    const key = getField(section.fields.key);
    sections[key] = {
      heading: getField(section.fields.heading) || '',
      description: getField(section.fields.description) || '',
      buttonText: getField(section.fields.buttonText) || undefined,
      buttonUrl: getField(section.fields.buttonUrl) || undefined,
    };
  });
} catch (error) {
  console.error('Error fetching page sections:', error);
}

// Get form and button sections
const submitButtonSection = { buttonText: getField(sections['sponsorer-submit-button']?.buttonText) || 'SEND BESKED' };
const contactEmailSection = { description: getField(sections['sponsorer-contact-email']?.description) || 'Eller kontakt os direkte:', buttonText: getField(sections['sponsorer-contact-email']?.buttonText) || 'kontakt@madsenracing.dk', buttonUrl: getField(sections['sponsorer-contact-email']?.buttonUrl) || 'mailto:kontakt@madsenracing.dk' };

// Get sponsors from Contentful
let sponsors: Sponsor[] = [];

try {
  const sponsorEntries = await getSponsors();

  sponsors = sponsorEntries.map((sponsor: any) => ({
    name: sponsor.fields.name,
    logo: sponsor.fields.logo ? getImageUrl(sponsor.fields.logo, 200) : undefined,
    website: sponsor.fields.website,
    description: sponsor.fields.description,
  }));

} catch (error) {
  console.error('Error fetching sponsors:', error);
}

// Extract section content with fallbacks
const heroSection = sections['sponsorer-hero'] || {
  heading: 'VORES PARTNERE',
  description: 'Tak til alle der støtter Madsen Racing. Sammen gør vi drømmen om professionel motorsport mulig.',
};

const kontaktSection = sections['sponsorer-kontakt'] || {
  heading: 'KONTAKT OS',
  description: '',
};
---

<Layout
  title="Sponsorer"
  description="Bliv sponsor for Anton Madsen og Madsen Racing. Se sponsorpakker og fordele ved at støtte en kommende racerstjerne."
>
  <!-- Hero -->
  <section class="pt-32 pb-16 bg-mr-gradient-dark">
    <div class="max-w-6xl mx-auto px-4 text-center">
      <h1 class="text-4xl md:text-5xl font-black mb-4 font-display" set:html={heroSection.heading.replace(/PARTNERE/g, '<span class="text-mr-yellow">PARTNERE</span>')}>
      </h1>
      <p class="text-mr-gray-400 max-w-2xl mx-auto">
        {heroSection.description}
      </p>
    </div>
  </section>

  <!-- Current Sponsors -->
  {sponsors.length > 0 && (
    <section class="section bg-mr-black">
      <div class="max-w-6xl mx-auto px-4">
        <div class="flex flex-wrap justify-center gap-6">
          {sponsors.map(s => (
            <SponsorLogo name={s.name} logo={s.logo} website={s.website} />
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Contact Form -->
  <section id="kontakt" class="section bg-mr-black">
    <div class="max-w-2xl mx-auto px-4">
      <h2 class="section-title text-center mb-8" set:html={kontaktSection.heading.replace(/OS/g, '<span class="text-mr-yellow">OS</span>')}></h2>

      <form class="space-y-6">
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm text-mr-gray-400 mb-2">Navn *</label>
            <input
              type="text"
              required
              class="w-full px-4 py-3 bg-mr-gray-900 border border-mr-gray-700 rounded-lg focus:border-mr-yellow focus:outline-none transition-colors"
              placeholder="Dit navn"
            />
          </div>
          <div>
            <label class="block text-sm text-mr-gray-400 mb-2">Virksomhed</label>
            <input
              type="text"
              class="w-full px-4 py-3 bg-mr-gray-900 border border-mr-gray-700 rounded-lg focus:border-mr-yellow focus:outline-none transition-colors"
              placeholder="Virksomhedsnavn"
            />
          </div>
        </div>

        <div>
          <label class="block text-sm text-mr-gray-400 mb-2">Email *</label>
          <input
            type="email"
            required
            class="w-full px-4 py-3 bg-mr-gray-900 border border-mr-gray-700 rounded-lg focus:border-mr-yellow focus:outline-none transition-colors"
            placeholder="din@email.dk"
          />
        </div>

        <div>
          <label class="block text-sm text-mr-gray-400 mb-2">Besked *</label>
          <textarea
            required
            rows="5"
            class="w-full px-4 py-3 bg-mr-gray-900 border border-mr-gray-700 rounded-lg focus:border-mr-yellow focus:outline-none transition-colors resize-none"
            placeholder="Fortæl os om din interesse i sponsorat..."
          ></textarea>
        </div>

        <button type="submit" class="btn-primary w-full">
          {submitButtonSection.buttonText}
        </button>
      </form>

      <div class="mt-8 text-center text-mr-gray-500 text-sm">
        <p>{contactEmailSection.description}</p>
        <a href={contactEmailSection.buttonUrl} class="text-mr-yellow hover:underline">
          {contactEmailSection.buttonText}
        </a>
      </div>
    </div>
  </section>
</Layout>
