---
import Layout from '../layouts/Layout.astro';
import SponsorLogo from '../components/SponsorLogo.astro';
import { getSponsorsByTier, getImageUrl, getSponsorPackages, getPageSections } from '../lib/contentful';

interface Sponsor {
  name: string;
  tier: 'guld' | 'sølv' | 'bronze';
  logo?: string;
  website?: string;
  description?: string;
}

interface SponsorPackage {
  name: string;
  tier: string;
  price: string;
  color: string;
  popular: boolean;
  features: string[];
}

// Get sponsors from Contentful
let sponsors: {
  guld: Sponsor[];
  sølv: Sponsor[];
  bronze: Sponsor[];
} = {
  guld: [],
  sølv: [],
  bronze: [],
};

try {
  const sponsorsByTier = await Promise.all([
    getSponsorsByTier('guld'),
    getSponsorsByTier('sølv'),
    getSponsorsByTier('bronze')
  ]);

  sponsors.guld = sponsorsByTier[0].map((sponsor: any) => ({
    name: sponsor.fields.name,
    tier: sponsor.fields.tier,
    logo: sponsor.fields.logo ? getImageUrl(sponsor.fields.logo, 200) : undefined,
    website: sponsor.fields.website,
    description: sponsor.fields.description,
  }));

  sponsors.sølv = sponsorsByTier[1].map((sponsor: any) => ({
    name: sponsor.fields.name,
    tier: sponsor.fields.tier,
    logo: sponsor.fields.logo ? getImageUrl(sponsor.fields.logo, 200) : undefined,
    website: sponsor.fields.website,
    description: sponsor.fields.description,
  }));

  sponsors.bronze = sponsorsByTier[2].map((sponsor: any) => ({
    name: sponsor.fields.name,
    tier: sponsor.fields.tier,
    logo: sponsor.fields.logo ? getImageUrl(sponsor.fields.logo, 200) : undefined,
    website: sponsor.fields.website,
    description: sponsor.fields.description,
  }));

} catch (error) {
  console.error('Error fetching sponsors:', error);
  // Fallback to empty sponsors
}

// Get sponsor packages from Contentful
let packages: SponsorPackage[] = [];

try {
  const packageEntries = await getSponsorPackages();

  // Helper function to get field value with Danish locale fallback
  const getFieldValue = (field: any): any => {
    if (!field) return undefined;
    if (typeof field === 'object' && !Array.isArray(field)) {
      return field['da-DK'] || field['en-US'] || field;
    }
    return field;
  };

  packages = packageEntries.map((pkg: any) => {
    const tier = getFieldValue(pkg.fields.tier);
    const name = getFieldValue(pkg.fields.name);
    const price = getFieldValue(pkg.fields.price);
    const priceLabel = getFieldValue(pkg.fields.priceLabel);
    const features = getFieldValue(pkg.fields.features) || [];

    // Map tier to border color
    const colorMap: Record<string, string> = {
      'bronze': 'border-amber-700',
      'silver': 'border-mr-gray-400',
      'gold': 'border-mr-yellow',
    };

    // Format price display
    const priceDisplay = priceLabel || `${price.toLocaleString('da-DK')} kr`;

    return {
      name: name.toUpperCase(),
      tier,
      price: priceDisplay,
      color: colorMap[tier] || 'border-mr-gray-400',
      popular: tier === 'gold', // Gold is always popular
      features,
    };
  });
} catch (error) {
  console.error('Error fetching sponsor packages:', error);
  // Fallback to hardcoded packages if Contentful fails
  packages = [
    {
      name: 'BRONZE',
      tier: 'bronze',
      price: '5.000 kr',
      color: 'border-amber-700',
      popular: false,
      features: [
        'Logo på website',
        'Omtale på social media (1x)',
        'Tak i nyhedsbreve',
      ]
    },
    {
      name: 'SØLV',
      tier: 'silver',
      price: '7.500 kr',
      color: 'border-mr-gray-400',
      popular: false,
      features: [
        'Alt fra Bronze',
        'Logo på kørerdragt',
        'Omtale på social media (3x)',
        'Billeder til egen markedsføring',
      ]
    },
    {
      name: 'GULD',
      tier: 'gold',
      price: '10.000+ kr',
      color: 'border-mr-yellow',
      popular: true,
      features: [
        'Alt fra Sølv',
        'Prominent logo på kart',
        'VIP-adgang til udvalgte løb',
        'Månedlig social media eksponering',
        'Skræddersyet partnerskab',
      ]
    },
  ];
}

// Get page sections from Contentful
let sections: Record<string, { heading: string; description: string }> = {};

try {
  const sectionEntries = await getPageSections('sponsorer');

  // Helper function to get field value with Danish locale fallback
  const getFieldValue = (field: any): any => {
    if (!field) return '';
    if (typeof field === 'object' && !Array.isArray(field)) {
      return field['da-DK'] || field['en-US'] || field;
    }
    return field;
  };

  sectionEntries.forEach((section: any) => {
    const key = getFieldValue(section.fields.key);
    sections[key] = {
      heading: getFieldValue(section.fields.heading) || '',
      description: getFieldValue(section.fields.description) || '',
    };
  });
} catch (error) {
  console.error('Error fetching page sections:', error);
  // Fallback to hardcoded sections
  sections = {
    'sponsorer-hero': {
      heading: 'VORES PARTNERE',
      description: 'Tak til alle der støtter Madsen Racing. Sammen gør vi drømmen om professionel motorsport mulig.',
    },
    'sponsorer-packages': {
      heading: 'BLIV SPONSOR',
      description: 'Støt en ung dansk racertalent og få eksponering for din virksomhed. Vælg den pakke der passer til dit budget.',
    },
    'sponsorer-kontakt': {
      heading: 'KONTAKT OS',
      description: '',
    },
  };
}

// Extract section content with fallbacks
const heroSection = sections['sponsorer-hero'] || {
  heading: 'VORES PARTNERE',
  description: 'Tak til alle der støtter Madsen Racing. Sammen gør vi drømmen om professionel motorsport mulig.',
};

const packagesSection = sections['sponsorer-packages'] || {
  heading: 'BLIV SPONSOR',
  description: 'Støt en ung dansk racertalent og få eksponering for din virksomhed. Vælg den pakke der passer til dit budget.',
};

const kontaktSection = sections['sponsorer-kontakt'] || {
  heading: 'KONTAKT OS',
  description: '',
};
---

<Layout 
  title="Sponsorer" 
  description="Bliv sponsor for Anton Madsen og Madsen Racing. Se sponsorpakker og fordele ved at støtte en kommende racerstjerne."
>
  <!-- Hero -->
  <section class="pt-32 pb-16 bg-mr-gradient-dark">
    <div class="max-w-6xl mx-auto px-4 text-center">
      <h1 class="text-4xl md:text-5xl font-black mb-4 font-display" set:html={heroSection.heading.replace(/PARTNERE/g, '<span class="text-mr-yellow">PARTNERE</span>')}>
      </h1>
      <p class="text-mr-gray-400 max-w-2xl mx-auto">
        {heroSection.description}
      </p>
    </div>
  </section>

  <!-- Current Sponsors -->
  <section class="section bg-mr-black">
    <div class="max-w-6xl mx-auto px-4">
      <!-- Gold -->
      {sponsors.guld.length > 0 && (
        <div class="mb-12">
          <h3 class="text-lg font-bold text-mr-yellow mb-6 text-center">GULD PARTNERE</h3>
          <div class="flex flex-wrap justify-center gap-6">
            {sponsors.guld.map(s => (
              <SponsorLogo name={s.name} tier={s.tier} />
            ))}
          </div>
        </div>
      )}
      
      <!-- Silver -->
      {sponsors.sølv.length > 0 && (
        <div class="mb-12">
          <h3 class="text-lg font-bold text-mr-gray-400 mb-6 text-center">SØLV PARTNERE</h3>
          <div class="flex flex-wrap justify-center gap-6">
            {sponsors.sølv.map(s => (
              <SponsorLogo name={s.name} tier={s.tier} />
            ))}
          </div>
        </div>
      )}
      
      <!-- Bronze -->
      {sponsors.bronze.length > 0 && (
        <div>
          <h3 class="text-lg font-bold text-amber-700 mb-6 text-center">BRONZE PARTNERE</h3>
          <div class="flex flex-wrap justify-center gap-6">
            {sponsors.bronze.map(s => (
              <SponsorLogo name={s.name} tier={s.tier} />
            ))}
          </div>
        </div>
      )}
    </div>
  </section>

  <!-- Become a Sponsor -->
  <section class="section bg-mr-gray-900/50">
    <div class="max-w-6xl mx-auto px-4">
      <div class="text-center mb-12">
        <h2 class="section-title" set:html={packagesSection.heading.replace(/SPONSOR/g, '<span class="text-mr-yellow">SPONSOR</span>')}></h2>
        <p class="section-subtitle max-w-2xl mx-auto">
          {packagesSection.description}
        </p>
      </div>

      <div class="grid md:grid-cols-3 gap-6 mb-12">
        {packages.map(pkg => (
          <div class:list={[
            'card relative',
            `border-2 ${pkg.color}`,
            pkg.popular && 'scale-105'
          ]}>
            {pkg.popular && (
              <div class="absolute -top-3 left-1/2 -translate-x-1/2 px-3 py-1 bg-mr-yellow text-mr-black text-xs font-bold rounded-full">
                POPULÆR
              </div>
            )}
            
            <div class="text-center mb-6">
              <h3 class="text-xl font-black mb-2">{pkg.name}</h3>
              <div class="text-3xl font-black text-mr-yellow">{pkg.price}</div>
              <p class="text-mr-gray-500 text-sm">pr. sæson</p>
            </div>
            
            <ul class="space-y-3 mb-6">
              {pkg.features.map(feature => (
                <li class="flex items-start gap-2 text-sm">
                  <svg class="w-5 h-5 text-mr-yellow flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  <span class="text-mr-gray-300">{feature}</span>
                </li>
              ))}
            </ul>
            
            <a href="#kontakt" class:list={[
              'block text-center py-3 rounded-lg font-bold transition-all',
              pkg.popular ? 'bg-mr-yellow text-mr-black hover:bg-mr-yellow/90' : 'bg-mr-gray-700 hover:bg-mr-gray-600'
            ]}>
              KONTAKT OS
            </a>
          </div>
        ))}
      </div>

      <p class="text-center text-mr-gray-400">
        Ønsker du en skræddersyet pakke? <a href="#kontakt" class="text-mr-yellow hover:underline">Kontakt os</a> for at høre mere.
      </p>
    </div>
  </section>

  <!-- Contact Form -->
  <section id="kontakt" class="section bg-mr-black">
    <div class="max-w-2xl mx-auto px-4">
      <h2 class="section-title text-center mb-8" set:html={kontaktSection.heading.replace(/OS/g, '<span class="text-mr-yellow">OS</span>')}></h2>
      
      <form class="space-y-6">
        <div class="grid md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm text-mr-gray-400 mb-2">Navn *</label>
            <input 
              type="text" 
              required
              class="w-full px-4 py-3 bg-mr-gray-900 border border-mr-gray-700 rounded-lg focus:border-mr-yellow focus:outline-none transition-colors"
              placeholder="Dit navn"
            />
          </div>
          <div>
            <label class="block text-sm text-mr-gray-400 mb-2">Virksomhed</label>
            <input 
              type="text" 
              class="w-full px-4 py-3 bg-mr-gray-900 border border-mr-gray-700 rounded-lg focus:border-mr-yellow focus:outline-none transition-colors"
              placeholder="Virksomhedsnavn"
            />
          </div>
        </div>
        
        <div>
          <label class="block text-sm text-mr-gray-400 mb-2">Email *</label>
          <input 
            type="email" 
            required
            class="w-full px-4 py-3 bg-mr-gray-900 border border-mr-gray-700 rounded-lg focus:border-mr-yellow focus:outline-none transition-colors"
            placeholder="din@email.dk"
          />
        </div>
        
        <div>
          <label class="block text-sm text-mr-gray-400 mb-2">Besked *</label>
          <textarea 
            required
            rows="5"
            class="w-full px-4 py-3 bg-mr-gray-900 border border-mr-gray-700 rounded-lg focus:border-mr-yellow focus:outline-none transition-colors resize-none"
            placeholder="Fortæl os om din interesse i sponsorat..."
          ></textarea>
        </div>
        
        <button type="submit" class="btn-primary w-full">
          SEND BESKED
        </button>
      </form>
      
      <div class="mt-8 text-center text-mr-gray-500 text-sm">
        <p>Eller kontakt os direkte:</p>
        <a href="mailto:kontakt@madsenracing.dk" class="text-mr-yellow hover:underline">
          kontakt@madsenracing.dk
        </a>
      </div>
    </div>
  </section>
</Layout>
