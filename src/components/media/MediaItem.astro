---
import OptimizedImage from './OptimizedImage.astro';
import YouTubePlayer from './YouTubePlayer.astro';
import { getImageUrl, formatDate } from '../../lib/contentful';

export interface Props {
  item: {
    fields: {
      title: string;
      description?: string;
      file?: { fields?: { file?: { url?: string } } };
      type?: string;
      category?: string;
      date?: string;
      tags?: string[];
      photographer?: string;
      location?: string;
      youtubeVideoId?: string;
      youtubeUrl?: string;
      duration?: number;
    };
  };
  size?: 'small' | 'medium' | 'large';
  showTitle?: boolean;
  showDate?: boolean;
  showMeta?: boolean;
  className?: string;
}

const {
  item,
  size = 'medium',
  showTitle = true,
  showDate = true,
  showMeta = true,
  className = '',
} = Astro.props;

const { fields } = item;
const {
  title,
  description,
  file,
  type = 'image',
  category = 'racing-action',
  date,
  tags = [],
  photographer,
  location,
  youtubeVideoId,
  youtubeUrl,
  duration,
} = fields;

const imageUrl = file ? getImageUrl(file, 800) : '';
const formattedDate = date ? formatDate(date) : '';
const categoryLabels = {
  'racing-action': 'Racing Action',
  'behind-scenes': 'Behind Scenes',
  'professional': 'Professional',
  'interviews': 'Interviews',
};

const sizeClasses = {
  small: 'col-span-1 row-span-1',
  medium: 'col-span-1 row-span-2 md:col-span-2',
  large: 'col-span-1 row-span-3 md:col-span-2 md:row-span-3',
};

const aspectRatio = type === 'video' ? 'aspect-video' : 'aspect-square';
---

<div class={`media-item group relative overflow-hidden rounded-lg shadow-md hover:shadow-xl transition-all duration-300 cursor-pointer ${sizeClasses[size]} ${className} ${aspectRatio}`}>
  {type === 'image' ? (
    <!-- Image content -->
    <>
      <div class="relative w-full h-full">
        <OptimizedImage
          src={imageUrl}
          alt={title}
          width={800}
          height={600}
          quality={85}
          format="webp"
          class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
          fit="cover"
        />

        <!-- Hover overlay -->
        <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-0 group-hover:opacity-90 transition-opacity duration-300">
          <div class="absolute bottom-0 left-0 right-0 p-4 text-white">
            {showTitle && (
              <h3 class="font-bold text-lg mb-1 line-clamp-2">{title}</h3>
            )}
            {description && (
              <p class="text-sm opacity-90 line-clamp-2 mb-2">{description}</p>
            )}
            {showMeta && (
              <div class="flex flex-wrap gap-2 text-xs">
                <span class="bg-mr-yellow text-mr-black px-2 py-1 rounded-full font-medium">
                  {categoryLabels[category] || category}
                </span>
                {date && (
                  <span class="bg-mr-purple bg-opacity-80 px-2 py-1 rounded-full">
                    {formattedDate}
                  </span>
                )}
                {photographer && (
                  <span class="bg-mr-gray-700 bg-opacity-80 px-2 py-1 rounded-full">
                    üì∏ {photographer}
                  </span>
                )}
              </div>
            )}
          </div>
        </div>
      </div>

      <!-- Click indicator -->
      <div class="absolute top-4 right-4 bg-mr-yellow text-mr-black p-2 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
        </svg>
      </div>
    </>
  ) : type === 'video' ? (
    <!-- Video content -->
    <>
      <YouTubePlayer
        videoId={youtubeVideoId}
        videoUrl={youtubeUrl}
        title={title}
        className="w-full h-full"
        width={800}
        height={450}
      />

      <!-- Video overlay with metadata -->
      <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent text-white">
        {showTitle && (
          <h3 class="font-bold text-lg mb-1 flex items-center gap-2">
            <span>{title}</span>
            {duration && (
              <span class="text-xs bg-mr-purple bg-opacity-80 px-2 py-1 rounded-full">
                {Math.floor(duration / 60)}:{(duration % 60).toString().padStart(2, '0')}
              </span>
            )}
          </h3>
        )}
        {showMeta && (
          <div class="flex flex-wrap gap-2 text-xs">
            <span class="bg-mr-yellow text-mr-black px-2 py-1 rounded-full font-medium">
              ‚ñ∂Ô∏è Video
            </span>
            {category && (
              <span class="bg-mr-purple bg-opacity-80 px-2 py-1 rounded-full">
                {categoryLabels[category] || category}
              </span>
            )}
            {date && (
              <span class="bg-mr-gray-700 bg-opacity-80 px-2 py-1 rounded-full">
                {formattedDate}
              </span>
            )}
          </div>
        )}
      </div>
    </>
  ) : (
    <!-- Fallback for unknown media type -->
    <div class="flex items-center justify-center w-full h-full bg-gray-100 text-gray-500">
      <div class="text-center p-4">
        <svg class="w-12 h-12 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        <p class="text-sm">Unknown media type</p>
        <p class="text-xs mt-1">{title}</p>
      </div>
    </div>
  )}

  <!-- Loading skeleton -->
  <div class="absolute inset-0 bg-gray-200 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
</div>

<style>
  .line-clamp-1 {
    display: -webkit-box;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .media-item {
    grid-column: span 1;
    grid-row: span 1;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .media-item.col-span-2 {
      grid-column: span 1;
    }
    .media-item.row-span-2,
    .media-item.row-span-3 {
      grid-row: span 2;
    }
  }
</style>